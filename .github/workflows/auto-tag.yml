name: autotag deploy nextjs
on: 
  push:
    branches:
      - ci-test
jobs:
  nextjs:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 14
      - name: "Install vercel"
        run: npm i -g vercel
      - name: "Deploy to vercel"
        id: deploy
        run: |
          prodRun=""
          echo "::set-output name=DEPLOYMENT_URL::$(vercel --confirm -t $VERCEL_TOKEN --scope $VERCEL_ORG_ID)"
      - name: "Calculate next git tag"
        id: bump
        uses: mathieudutour/github-tag-action@v6.0
        with:
          default_bump : "major"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag_prefix: ""
          append_to_pre_release_tag: ""
          default_prerelease_bump: "prerelease"
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          body: "deployment url: ${{ steps.deploy.outputs.DEPLOYMENT_URL }} \n tag name: ${{ steps.bump.outputs.new_tag }}\n"
          tag_name: ${{ steps.bump.outputs.new_tag }}
          generate_release_notes: true
